# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Windows voice dictation utility using GPU-accelerated Whisper transcription. Hold Alt+F to record, release to transcribe and inject text into the active window.

## Tech Stack

- **Python 3.13+** (Windows 64-bit)
- **faster-whisper** - CUDA-optimized Whisper (float16, small model)
- **keyboard** - Global hotkey capture
- **sounddevice/soundfile** - Audio streaming and I/O
- **edge-tts** - Microsoft neural TTS for speak.py

## Installation

See `README.md` for detailed prerequisites (Python, CUDA).

```batch
install.bat                :: Setup wizard (checks Python, GPU, configures hotkey)
test-install.bat           :: Verify everything works
```

## Running

```batch
start-dictation.bat        :: Main launcher (uses venv if present)
launch.cmd                 :: Headless with logging to hook.log
```

For text-to-speech:
```bash
python speak.py "Your message here"
```

## Key Files

| File | Purpose |
|------|---------|
| `dictate.py` | Main voice recording and transcription app |
| `speak.py` | Edge TTS text-to-speech utility |
| `install.bat` | One-time setup wizard (Python check, venv, deps, GPU, hotkey) |
| `test-install.bat` | Verifies installation is working |
| `start-dictation.bat` | Launch the tool |
| `config.py` | User configuration - generated by install.bat |
| `requirements.txt` | Python dependencies |
| `README.md` | User-facing setup instructions and troubleshooting |

## Architecture

- **Single-instance lock**: PID-based lock at `%TEMP%\voice-dictation.lock` prevents multiple instances
- **Streaming audio**: Callback-based audio capture with 16kHz mono float32
- **Hotkey listener**: Alt+F with suppress=True to prevent system capture
- **Release monitor**: Daemon thread polling key release at 10ms intervals
- **Lazy model loading**: Whisper model loads after startup message for better UX
- **Text injection**: Clipboard copy + keyboard typing with 10ms delay per character

## Configuration (config.py)

Generated by `install.bat` or edit manually:

```python
HOTKEY = 'alt+f'          # Hold to record, release to transcribe
MODEL_SIZE = 'small'      # tiny, base, small, medium, large
DEVICE = 'cuda'           # 'cuda' for GPU, 'cpu' for CPU-only
COMPUTE_TYPE = 'float16'  # 'float16' for GPU, 'int8' for CPU
AUDIO_DEVICE = None       # None = system default, or device index
```

Avoid common hotkeys: ctrl+c/v/x/z, ctrl+s, alt+tab, alt+f4

## Known Issues

- **Text injection delay**: 10ms delay between keystrokes prevents Claude Code TUI crash from rapid input
- **Audio device errors**: Device index configuration may need adjustment based on hardware

## Logging

- **Location**: `dictation.log` (same directory)
- **Level**: DEBUG
- **Format**: `timestamp [LEVEL] message`
