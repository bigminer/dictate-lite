# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Windows voice dictation utility using GPU-accelerated Whisper transcription. Hold a hotkey to record, release to transcribe and inject text into the active window. Runs in system tray.

## Tech Stack

- **Python 3.11+** (Windows 64-bit)
- **faster-whisper** - CUDA-optimized Whisper transcription
- **keyboard** - Global hotkey capture
- **sounddevice/soundfile** - Audio streaming and I/O
- **numpy** - Audio array processing
- **pyperclip** - Clipboard operations for text injection
- **pystray/Pillow** - System tray icon
- **edge-tts** - Microsoft neural TTS for speak.py

## Installation

See `README.md` for detailed prerequisites (Python, CUDA).

```batch
install.bat                :: Setup wizard (Python, GPU, hotkey, model, language)
test-install.bat           :: Verify everything works
uninstall.bat              :: Remove venv, config, and optionally model cache
```

## Running

```batch
start-dictation.bat        :: Main launcher - runs in system tray
launch.cmd                 :: Headless with logging to hook.log
```

## Key Files

| File | Purpose |
|------|---------|
| `dictate.py` | Main app - system tray, hotkey, transcription |
| `speak.py` | Edge TTS text-to-speech utility |
| `install.bat` | Setup wizard (idempotent - safe to re-run) |
| `uninstall.bat` | Cleanup script with model cache option |
| `test-install.bat` | Verifies installation is working |
| `config.py` | User configuration - generated by install.bat |
| `config.example.py` | Configuration template |
| `requirements.txt` | Python dependencies |
| `README.md` | User-facing setup and troubleshooting |
| `LICENSE` | MIT License |

## Architecture

- **System tray**: Colored circle icon (gray=loading, green=ready, red=recording, yellow=processing)
- **Single-instance lock**: PID-based lock at `%TEMP%\voice-dictation.lock`
- **Streaming audio**: Callback-based capture with 16kHz mono float32
- **Hotkey listener**: Configurable hotkey with suppress=True
- **Release monitor**: Daemon thread polling key release at 10ms intervals
- **Lazy model loading**: Model loads after tray starts
- **Text injection**: Clipboard copy + keyboard typing with 10ms delay

## Configuration (config.py)

Generated by `install.bat` or edit manually:

```python
HOTKEY = 'alt+f'          # Hold to record, release to transcribe
MODEL_SIZE = 'small'      # tiny, base, small, medium, large
LANGUAGE = 'en'           # 'en', 'auto', 'es', 'fr', 'de', etc.
DEVICE = 'cuda'           # 'cuda' for GPU, 'cpu' for CPU-only
COMPUTE_TYPE = 'float16'  # 'float16' for GPU, 'int8' for CPU
AUDIO_DEVICE = None       # None = system default, or device index
```

## Model Cache

Whisper models are downloaded to `%USERPROFILE%\.cache\huggingface\hub` on first run.
Sizes: tiny ~75MB, base ~150MB, small ~500MB, medium ~1.5GB, large ~3GB

## Known Issues

- **Text injection delay**: 10ms delay between keystrokes prevents Claude Code TUI crash
- **Audio device errors**: Device index may need adjustment based on hardware

## Logging

- **Location**: `%USERPROFILE%\voice-dictation\dictation.log`
- **Level**: DEBUG
- **Format**: `timestamp [LEVEL] message`
