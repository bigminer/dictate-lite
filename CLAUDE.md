# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Windows voice dictation utility using GPU-accelerated Whisper transcription. Hold a hotkey to record, release to transcribe and inject text into the active window. Runs in system tray.

## Quick Start

```batch
install.bat          :: Setup wizard - configures Python venv, GPU, hotkey, model
test-install.bat     :: Verify installation works
start-dictation.bat  :: Run the app (system tray)
```

## Development

```batch
:: Activate venv and run directly for testing
.venv\Scripts\activate
python src\dictate.py

:: Test TTS utility
.venv\Scripts\python src\speak.py "Test message"

:: Run with visible console output (for debugging)
launch.cmd
```

Logs are written to `%USERPROFILE%\voice-dictation\dictation.log` (DEBUG level).

## Architecture

**Control flow in `src/dictate.py`:**

1. `main()` → single-instance check → microphone check → tray icon (gray)
2. Model loads lazily in background → tray turns green
3. `keyboard.add_hotkey()` registers press handler with `suppress=True`
4. Daemon thread polls for key release at 10ms intervals
5. Press: `start_recording()` → tray red, audio callback fills `recorded_frames[]`
6. Release: `stop_recording_and_transcribe()` → tray yellow → transcribe → `keyboard.write()` → tray green

**Key design decisions:**
- Audio uses callback-based streaming (16kHz mono float32) rather than blocking reads
- Text injection throttled to 10ms/char to prevent Claude Code TUI crash
- Single-instance enforced via PID file at `%TEMP%\voice-dictation.lock`

## Key Files

| File | Purpose |
|------|---------|
| `src/dictate.py` | Main app - system tray, hotkey, transcription loop |
| `src/speak.py` | Edge TTS utility - async audio generation + PowerShell playback |
| `src/claude_status_tts.py` | Claude Code status line wrapper with context % alerts |
| `src/config.py` | User config (generated by install.bat) |
| `src/config.example.py` | Config template with all options documented |

## Configuration Options

Generated by `install.bat` or copy from `src/config.example.py`:

```python
HOTKEY = 'alt+f'          # Hold to record, release to transcribe
MODEL_SIZE = 'small'      # tiny, base, small, medium, large
LANGUAGE = 'en'           # 'en', 'auto', or language code
DEVICE = 'cuda'           # 'cuda' for GPU, 'cpu' for CPU-only
COMPUTE_TYPE = 'float16'  # 'float16' for GPU, 'int8' for CPU
AUDIO_DEVICE = None       # None = system default, or device index
NOISE_REDUCTION = False   # Filter background noise (requires noisereduce)
USE_CLIPBOARD = True      # Backup text to clipboard
VOCABULARY = ''           # Custom words: 'Claude, TypeScript, JIRA'
```

## Model Cache

Whisper models download to `%USERPROFILE%\.cache\huggingface\hub` on first run.
Sizes: tiny ~75MB, base ~150MB, small ~500MB, medium ~1.5GB, large ~3GB
